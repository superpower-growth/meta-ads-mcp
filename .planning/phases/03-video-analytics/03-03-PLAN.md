---
phase: 03-video-analytics
plan: 03
type: execute
---

<objective>
Complete Phase 3 with advanced video engagement analysis tool providing retention insights and watch time patterns.

Purpose: Enable deep video creative analysis by exposing 2-second views, 15/30-second thresholds, and derived engagement metrics that show how compelling video content is beyond simple completion rates.

Output: get-video-engagement MCP tool that analyzes retention patterns, calculates average watch percentage, and identifies strong/weak video performance indicators for creative optimization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-metrics-query/DISCOVERY.md
@.planning/phases/03-video-analytics/03-01-SUMMARY.md
@.planning/phases/03-video-analytics/03-02-SUMMARY.md

# Key files
@src/meta/metrics.ts
@src/lib/parsers.ts
@src/tools/get-video-performance.ts
@src/tools/get-video-demographics.ts
@src/tools/index.ts
@src/index.ts

**Tech stack available:** MetricsService with breakdown support, parseVideoMetrics, video tool patterns

**Established patterns:**
- Video completion funnel format from 03-01
- Demographic segmentation from 03-02
- Manual inputSchema for MCP tools
- Pretty-printed JSON responses

**Constraining decisions:**
- DISCOVERY.md Section "Video Completion Metrics": video_15_sec, video_30_sec, video_continuous_2_sec fields available
- DISCOVERY.md: video_thruplay = 15s OR complete view (whichever comes first)
- Plan 03-01: Completion percentiles (25/50/75/95/100) extracted via parseVideoMetrics
- Plan 03-02: MetricsService supports breakdowns

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video engagement analysis utility</name>
  <files>src/lib/video-analysis.ts</files>
  <action>
Create utility module for calculating derived video engagement metrics.

Export functions:

1. calculateAverageWatchPercentage(completionData):
   - Input: { plays, p25, p50, p75, p95, p100 }
   - Estimate using midpoint method:
     - Assume viewers who reached 25% watched average 12.5% before dropping
     - Viewers 25-50% watched average 37.5%, etc.
   - Weighted calculation:
     ```typescript
     const segments = [
       { count: plays - p25, avgPct: 12.5 },
       { count: p25 - p50, avgPct: 37.5 },
       { count: p50 - p75, avgPct: 62.5 },
       { count: p75 - p95, avgPct: 85 },
       { count: p95 - p100, avgPct: 97.5 },
       { count: p100, avgPct: 100 }
     ];
     return weightedAverage(segments);
     ```
   - Return percentage (e.g., 67.3)

2. calculateRetentionScore(completionData, impressions):
   - Engagement rate: (plays / impressions) * 100
   - Retention quality: Average of completion rates at each percentile
   - Combined score: (engagement_rate * 0.4) + (retention_quality * 0.6)
   - Return 0-100 score indicating overall video strength

3. identifyWeakPoints(completionData):
   - Find largest drop-offs between consecutive percentiles
   - Return array of { from: '25%', to: '50%', dropPct: 34.2 } for drops >20%
   - Helps identify where viewers lose interest

4. classifyPerformance(completionData):
   - Based on 100% completion rate:
     - Excellent: >30%
     - Good: 20-30%
     - Average: 10-20%
     - Poor: <10%
   - Return classification string

Add JSDoc documentation for each function with examples.

Why separate module: Reusable analysis logic across multiple tools. Makes testing easier (can unit test calculations separately from API calls).

What to avoid: Don't make assumptions about video length (we don't have duration data). Don't require exact precision (these are estimates for insight, not analytics dashboards).
  </action>
  <verify>npm run type-check passes, all functions exported with proper TypeScript types, JSDoc complete</verify>
  <done>Video analysis utility module created with 4 calculation functions, type-safe, well-documented</done>
</task>

<task type="auto">
  <name>Task 2: Create get-video-engagement MCP tool</name>
  <files>src/tools/get-video-engagement.ts</files>
  <action>
Create MCP tool for advanced video engagement analysis using new utility module.

Zod schema:
```typescript
const schema = z.object({
  dateRange: z.enum(['last_7d', 'last_30d', 'last_90d', 'this_month']).default('last_7d'),
  level: z.enum(['campaign', 'adset', 'ad']).default('campaign'),
  entityId: z.string().optional(),
  includeWeakPoints: z.boolean().default(true)
});
```

Tool definition:
- name: 'get-video-engagement'
- description: 'Analyze video ad engagement depth with retention scores, average watch percentage, and drop-off identification for creative optimization'
- Manual inputSchema

Implementation:
1. Initialize MetricsService
2. Request fields:
   - Video completion percentiles (p25-p100)
   - video_play_actions
   - video_continuous_2_sec_watched_actions
   - video_15_sec_watched_actions
   - video_30_sec_watched_actions
   - video_thruplay_watched_actions
   - impressions
3. Query insights at specified level
4. Filter by entityId if provided
5. For each result:
   - Parse video metrics using parseVideoMetrics()
   - Parse play/view counts using parseActions()
   - Calculate average watch percentage using calculateAverageWatchPercentage()
   - Calculate retention score using calculateRetentionScore()
   - Identify weak points using identifyWeakPoints() if includeWeakPoints=true
   - Classify performance using classifyPerformance()
6. Format response:
   ```json
   {
     "dateRange": "last_7d",
     "level": "campaign",
     "engagement": [
       {
         "id": "...",
         "name": "...",
         "impressions": 12500,
         "plays": 5420,
         "viewDepth": {
           "2secViews": 4890,
           "15secViews": 3200,
           "30secViews": 2100,
           "thruplay": 1450,
           "completions": 1234
         },
         "engagementMetrics": {
           "playRate": "43.36%",
           "avgWatchPct": "67.3%",
           "retentionScore": 72.4,
           "classification": "Good"
         },
         "weakPoints": [
           { "from": "25%", "to": "50%", "dropPct": 34.2 },
           { "from": "75%", "to": "95%", "dropPct": 25.1 }
         ]
       }
     ]
   }
   ```
7. Return JSON.stringify(result, null, 2)

Error handling:
- If no video data, return "No video ad engagement data for date range"
- If entityId not found, return appropriate message
- Handle zero plays gracefully (return null metrics rather than errors)

Why this format: Combines raw counts with derived insights. Weak points highlight creative issues. Classification provides quick assessment.

What to avoid: Don't claim precision ("estimated" or "approximate" in descriptions). Don't recommend specific actions (that's Claude's job). Don't filter out poor performers (user wants all data).
  </action>
  <verify>npm run build succeeds, video analysis utility integrated, engagement scores calculated correctly</verify>
  <done>Video engagement tool implemented, retention scoring working, weak point identification functional</done>
</task>

<task type="auto">
  <name>Task 3: Register engagement tool and complete Phase 3</name>
  <files>src/tools/index.ts, src/index.ts</files>
  <action>
Register get-video-engagement tool to complete Phase 3 video analytics suite.

In src/tools/index.ts:
1. Import getVideoEngagementTool from './get-video-engagement.js'
2. Add to tools array (7 tools total)

In src/index.ts:
1. Import getVideoEngagement from './tools/get-video-engagement.js'
2. Add case to CallToolRequestSchema handler:
   ```typescript
   case 'get-video-engagement': {
     const result = await getVideoEngagement(args as any);
     return { content: [{ type: 'text', text: result }] };
   }
   ```

Verification:
- npm run build succeeds
- npm run dev starts without errors
- 7 tools discoverable (4 performance + 3 video analytics)
- All video tools operational

Phase 3 complete deliverables:
- Video completion funnel (03-01)
- Demographic breakdowns (03-02)
- Engagement depth analysis (03-03)
- 3 video-focused MCP tools
- Comprehensive video ad analysis capabilities

Why this completes Phase 3: Covers all aspects of video analytics from ROADMAP.md goal: "video-specific performance breakdowns by demographics and video length". Length analysis via completion percentiles, demographics via breakdowns.
  </action>
  <verify>npm run build && npm run dev succeeds, 7 tools total, Phase 3 goals achieved</verify>
  <done>Engagement tool registered, Phase 3 complete, full video analytics suite operational</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no TypeScript errors
- [ ] Video analysis utility functions work correctly
- [ ] Engagement scores calculated properly (0-100 range)
- [ ] Weak point identification finds major drop-offs
- [ ] All 3 Phase 3 tools (video-performance, video-demographics, video-engagement) working together
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Phase 3 complete: Video analytics fully implemented
- 7 MCP tools total operational
- Video completion, demographic, and engagement analysis available
- Creative optimization insights surfaced through MCP
- Foundation ready for Phase 4 (Comparative Reports)
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-analytics/03-03-SUMMARY.md`:

# Phase 3 Plan 03: Video Engagement Analysis Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/lib/video-analysis.ts` - Engagement calculation utilities
- `src/tools/get-video-engagement.ts` - Engagement analysis tool
- `src/tools/index.ts` - Tool registration
- `src/index.ts` - Handler registration

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Deviations from Plan

[Deviations or "None"]

## Next Phase Readiness

Phase 3 complete! Ready for Phase 4: Comparative Reports.

Video analytics suite complete with:
- Completion funnels (03-01)
- Demographic breakdowns (03-02)
- Engagement depth analysis (03-03)

Next phase will build on this foundation to enable week-over-week and campaign comparison reporting for trend analysis.

## Verification Checklist

- [ ] All verification items from plan
</output>
