---
phase: 03-video-analytics
plan: 02
type: execute
---

<objective>
Add demographic and platform breakdown support to video performance queries.

Purpose: Enable Claude to answer questions like "Which age groups engage most with my video ads?" and "Do men or women watch longer?" by adding breakdown dimensions to MetricsService and exposing through MCP tools.

Output: Enhanced MetricsService with breakdown support, new get-video-demographics MCP tool that segments video completion metrics by age, gender, country, and platform.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-metrics-query/DISCOVERY.md
@.planning/phases/03-video-analytics/03-01-SUMMARY.md

# Key files
@src/meta/metrics.ts
@src/lib/parsers.ts
@src/tools/get-video-performance.ts
@src/tools/index.ts
@src/index.ts

**Tech stack available:** MetricsService, parseVideoMetrics, video performance tool pattern

**Established patterns:**
- MetricsService for insights queries
- parseVideoMetrics for percentile extraction
- Manual inputSchema for MCP tools

**Constraining decisions:**
- DISCOVERY.md Section "Breakdowns (Advanced)": breakdowns param segments results
- DISCOVERY.md: Common breakdowns include age, gender, country, device_platform, publisher_platform
- DISCOVERY.md Warning: "Breakdowns multiply result rows"
- Plan 02-01: MetricsService accepts params object
- Plan 03-01: Video completion funnel format established

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add breakdown parameter support to MetricsService</name>
  <files>src/meta/metrics.ts</files>
  <action>
Enhance MetricsService to accept optional breakdowns parameter.

Modify getAccountInsights() and getAllInsights() method signatures:
- Accept breakdowns as optional parameter in params
- Pass through to SDK getInsights() call
- No other changes needed (SDK handles breakdowns automatically)

Add JSDoc documentation:
```typescript
/**
 * @param breakdowns - Optional array of breakdown dimensions (e.g., ['age', 'gender'])
 * WARNING: Breakdowns multiply result rows. age × gender = many rows per entity.
 * Common breakdowns: 'age', 'gender', 'country', 'region', 'device_platform', 'publisher_platform'
 */
```

TypeScript type update:
```typescript
interface InsightParams {
  date_preset?: string;
  time_range?: { since: string; until: string };
  level?: 'account' | 'campaign' | 'adset' | 'ad';
  time_increment?: number | string;
  limit?: number;
  breakdowns?: string[]; // New field
}
```

Why this approach: SDK natively supports breakdowns via params. We just need to expose it. DISCOVERY.md Section "Breakdowns (Advanced)" shows exact parameter format.

What to avoid: Don't validate breakdown names (let SDK return error if invalid). Don't limit to specific breakdowns (Meta adds new ones). Don't auto-aggregate breakdown results (caller handles segmentation).
  </action>
  <verify>npm run type-check passes, InsightParams type updated, breakdowns parameter optional</verify>
  <done>MetricsService supports breakdowns parameter, JSDoc warnings added, type-safe implementation</done>
</task>

<task type="auto">
  <name>Task 2: Create get-video-demographics MCP tool</name>
  <files>src/tools/get-video-demographics.ts</files>
  <action>
Create MCP tool for video performance segmented by demographic dimensions.

Zod schema:
```typescript
const schema = z.object({
  dateRange: z.enum(['last_7d', 'last_30d', 'last_90d', 'this_month']).default('last_7d'),
  level: z.enum(['campaign', 'adset', 'ad']).default('campaign'),
  entityId: z.string().optional(),
  breakdowns: z.array(z.enum(['age', 'gender', 'country', 'device_platform', 'publisher_platform'])).min(1).default(['age', 'gender'])
});
```

Tool definition:
- name: 'get-video-demographics'
- description: 'Query video completion metrics segmented by demographic breakdowns (age, gender, location, platform)'
- Manual inputSchema following established pattern

Implementation:
1. Initialize MetricsService
2. Build params with breakdowns from schema:
   ```typescript
   const params = {
     date_preset: args.dateRange,
     level: args.level,
     time_increment: 'all_days',
     breakdowns: args.breakdowns
   };
   ```
3. Request video completion fields (same as 03-01)
4. Call MetricsService.getAccountInsights(fields, params)
5. Filter by entityId if provided
6. Parse video metrics for each breakdown combination
7. Format response by grouping results by breakdown dimensions:
   ```json
   {
     "dateRange": "last_7d",
     "breakdowns": ["age", "gender"],
     "segments": [
       {
         "age": "25-34",
         "gender": "male",
         "completionFunnel": {
           "plays": 2340,
           "25percent": 1890,
           "50percent": 1456,
           ...
         },
         "completionRates": {
           "25percent": "80.77%",
           ...
         }
       },
       {
         "age": "25-34",
         "gender": "female",
         ...
       }
     ]
   }
   ```
8. Return JSON.stringify(result, null, 2)

Error handling:
- If no breakdown data found, return "No demographic breakdown data for date range"
- Warn if result set is very large (>100 segments): "Large result set - consider fewer breakdowns"

Why this format: Grouping by segments makes it easy for Claude to compare demographics. Breakdown combinations are explicit.

What to avoid: Don't try to aggregate breakdowns (each combination is independent). Don't filter low-volume segments (statistical significance is user's decision). Don't limit breakdown combinations (user chose them).
  </action>
  <verify>npm run build succeeds, breakdown parameter passed to MetricsService, segmented results formatted correctly</verify>
  <done>Demographic video tool created, breakdown segmentation working, multi-dimensional analysis enabled</done>
</task>

<task type="auto">
  <name>Task 3: Register demographic tool and update documentation</name>
  <files>src/tools/index.ts, src/index.ts</files>
  <action>
Register get-video-demographics tool in MCP server.

In src/tools/index.ts:
1. Import getVideoDemographicsTool from './get-video-demographics.js'
2. Add to tools array (6 tools total)

In src/index.ts:
1. Import getVideoDemographics from './tools/get-video-demographics.js'
2. Add case to CallToolRequestSchema handler:
   ```typescript
   case 'get-video-demographics': {
     const result = await getVideoDemographics(args as any);
     return { content: [{ type: 'text', text: result }] };
   }
   ```

Verification:
- npm run build succeeds
- npm run dev starts without errors
- 6 tools discoverable

Why this pattern: Consistent registration pattern. Demographic analysis as separate tool from base video performance keeps concerns separated.
  </action>
  <verify>npm run build && npm run dev succeeds, 6 tools registered, demographic breakdowns queryable</verify>
  <done>Demographic tool registered, MetricsService breakdown support complete, segmented video analysis operational</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds with no TypeScript errors
- [ ] MetricsService accepts breakdowns parameter
- [ ] Demographic tool returns segmented results
- [ ] Breakdown combinations handled correctly (age × gender = multiple rows)
- [ ] Large result sets don't cause errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- MetricsService enhanced with breakdown support
- Demographic video analysis queryable through MCP
- Multi-dimensional segmentation working
- Foundation ready for 03-03 (advanced video engagement)
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-analytics/03-02-SUMMARY.md`:

# Phase 3 Plan 02: Demographic Video Breakdowns Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/meta/metrics.ts` - Added breakdown parameter support
- `src/tools/get-video-demographics.ts` - Demographic segmentation tool
- `src/tools/index.ts` - Tool registration
- `src/index.ts` - Handler registration

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Deviations from Plan

[Deviations or "None"]

## Next Phase Readiness

Ready for 03-03-PLAN.md (Video Engagement Analysis). Demographic breakdowns enable audience targeting insights. Next plan will add engagement depth analysis and watch time patterns.

## Verification Checklist

- [ ] All verification items from plan
</output>
